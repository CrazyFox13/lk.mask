###########################################
#
# load balancer for docker compose project
#
###########################################
events {
    # Здесь могут быть дополнительные настройки, если это необходимо
}

http {
    server {
        listen 80;
        server_name lk.mack-group.ru;

        client_max_body_size 100M;
        client_body_timeout 120s;

        location / {
           proxy_pass http://web:3000;
        }

        location /api {
            root /var/www/public;
            try_files /index.php =404;

             # Laravel обрабатывает все запросы через index.php
            # try_files /index.php?$query_string =404;

             # Настройка передачи запросов на php-fpm
             include fastcgi_params;
             fastcgi_param SCRIPT_FILENAME $document_root/index.php;

             # Передача оригинального REQUEST_URI в PHP
             # Удалено изменение REQUEST_URI, т.к. Laravel должен получить оригинальный запрос
             # Backend использует network_mode: host, поэтому используем host.docker.internal или IP хоста
             # Пробуем сначала host.docker.internal, если не работает - используем IP gateway
             fastcgi_pass host.docker.internal:9000;

             fastcgi_split_path_info ^(.+\.php)(/.+)$;
             fastcgi_index index.php;
        }

        location /admin {
           proxy_pass http://frontend:8080;   # Перенаправление запросов на группу серверов API
           proxy_connect_timeout 120s;  # Таймаут установления соединения с сервером
           proxy_send_timeout 120s;     # Таймаут отправки запроса серверу
           proxy_read_timeout 120s;     # Таймаут ожидания ответа от сервера
        }


        location = /custom_404 {
            internal;
            return 404 'The requested service is not available.'; # Кастомное сообщение об ошибке
        }
    }
}